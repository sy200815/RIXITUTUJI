<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Chat</title>
    <style>
        /* CSS Reset and Global Styles */
        :root {
            --char-bubble-color: #E9E9EB;
            --user-bubble-color: #F4F4F5;
            --background-color: #FFFFFF;
            --text-color: #000000;
            --secondary-text-color: #8A8A8E;
            --button-bg-color: #F0F0F0;
            --button-hover-bg-color: #E0E0E0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --selection-color: #007AFF;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-size-chat: 16px; /* Controlled by JS */
        }

        html {
            font-size: 100%; /* Controlled by JS for global scaling */
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none; /* Prevent text selection during interaction */
        }

        body {
            height: 100vh; width: 100vw; overflow: hidden;
            font-family: var(--font-family); background-color: var(--background-color); color: var(--text-color);
        }

        #app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
            margin: 0 auto; max-width: 800px;
            background-size: cover; background-position: center center;
        }
        #app-container.edit-mode .input-area { display: none; }
        #app-container.edit-mode .message-selection-indicator { display: flex; }
        #app-container.edit-mode .message { transform: translateX(-1rem); }


        /* Status Bar */
        .status-bar {
            flex-shrink: 0; display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 1rem; padding-top: calc(0.75rem + env(safe-area-inset-top));
            background-image: url('https://files.catbox.moe/877yf9.jpg');
            background-size: cover; background-position: center; color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: background-color 0.3s;
            position: relative; overflow: hidden;
        }

        .status-bar-content {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; transition: transform 0.3s ease-in-out;
        }
        #app-container.edit-mode .status-bar-content.default-bar { transform: translateY(-150%); }
        #app-container.edit-mode .status-bar-content.edit-bar { transform: translateY(0); }


        .status-bar .char-info {
            display: flex; flex-direction: column; align-items: center;
            margin: 0 auto; min-height: 1.25rem;
        }
        .status-bar .char-name { font-weight: 600; font-size: 1.0625rem; transition: opacity 0.3s; }
        .status-bar button {
            background: none; border: none; cursor: pointer; padding: 0.3125rem;
            opacity: 0.9; transition: opacity 0.2s; color: white; font-size: 1rem;
        }
        .status-bar button:hover { opacity: 1; }
        .status-bar svg { width: 1.5rem; height: 1.5rem; fill: white; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3)); }
        
        .edit-bar {
            position: absolute; top: 0; left: 0; height: 100%;
            padding: 0.75rem 1rem; padding-top: calc(0.75rem + env(safe-area-inset-top));
            transform: translateY(150%);
        }
        .edit-bar button { font-weight: 600; }
        .edit-bar #delete-btn { color: #FF3B30; }


        /* Chat Area */
        .chat-container {
            flex-grow: 1; overflow-y: auto; padding: 1rem;
            display: flex; flex-direction: column;
        }
        .message-wrapper {
            display: flex; align-items: flex-end;
            transition: background-color 0.2s;
            margin-bottom: 0.9375rem;
        }
        
        .message-selection-indicator {
            display: none; align-items: center; justify-content: center;
            width: 2.5rem; flex-shrink: 0;
        }
        .selection-checkbox {
            width: 1.25rem; height: 1.25rem; border: 2px solid #ccc;
            border-radius: 50%; transition: all 0.2s;
        }
        .message-wrapper.selected .selection-checkbox {
            background-color: var(--selection-color); border-color: var(--selection-color);
        }
        .message-wrapper.selected .selection-checkbox::after {
            content: ''; display: block; width: 0.3rem; height: 0.6rem;
            border: solid white; border-width: 0 2px 2px 0;
            transform: rotate(45deg) translate(-0.05rem, -0.1rem);
            margin: 0.2rem auto;
        }

        .message {
            display: flex; align-items: flex-end;
            max-width: 75%;
            animation: fadeIn 0.3s ease-in-out;
            transition: transform 0.3s ease-in-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(0.625rem); } to { opacity: 1; transform: translateY(0); } }

        .message-wrapper.user { justify-content: flex-end; }
        .message-wrapper.character { justify-content: flex-start; }
        
        .message.user { flex-direction: row-reverse; }

        .message .avatar {
            width: 2.25rem; height: 2.25rem; border-radius: 50%; object-fit: cover;
            flex-shrink: 0; box-shadow: 0 1px 2px var(--shadow-color);
        }
        .message .bubble-wrapper { display: flex; flex-direction: column; }
        .message .bubble {
            padding: 0.375rem 0.875rem; border-radius: 1rem;
            word-wrap: break-word; white-space: pre-wrap; line-height: 1.35;
            font-size: var(--font-size-chat);
            user-select: text; /* Allow text selection inside bubble */
        }
        .message.user .avatar { margin-left: 0.625rem; }
        .message.user .bubble { background-color: var(--user-bubble-color); border-bottom-right-radius: 0.25rem; }
        .message.user .bubble-wrapper { align-items: flex-end; }
        .message.character .avatar { margin-right: 0.625rem; }
        .message.character .bubble { background-color: var(--char-bubble-color); border-bottom-left-radius: 0.25rem; }
        .read-status {
            font-size: 0.6875rem; color: var(--secondary-text-color); margin-top: 0.25rem;
            margin-right: 0.3125rem; margin-left: 0.3125rem;
        }

        /* Input Area */
        .input-area {
            flex-shrink: 0; display: flex; align-items: center; padding: 0.625rem;
            padding-bottom: calc(0.625rem + env(safe-area-inset-bottom));
            background-color: var(--background-color); border-top: 1px solid #EFEFEF;
        }
        .input-area button {
            flex-shrink: 0; background-color: var(--button-bg-color); border: none;
            border-radius: 50%; width: 2.25rem; height: 2.25rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; margin: 0 0.25rem;
            box-shadow: 0 1px 3px var(--shadow-color); transition: background-color 0.2s, transform 0.1s;
        }
        .input-area button:hover { background-color: var(--button-hover-bg-color); }
        .input-area button:active { transform: scale(0.95); }
        .input-area button svg { width: 1.25rem; height: 1.25rem; fill: #333; }
        .chat-input {
            flex-grow: 1; border: none; background-color: #F0F0F0; border-radius: 1.125rem;
            padding: 0.625rem 1rem; font-size: var(--font-size-chat);
            font-family: var(--font-family); outline: none;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            opacity: 1; transition: opacity 0.3s;
        }
        .settings-panel.hidden { opacity: 0; pointer-events: none; }
        .settings-content {
            background-color: #F9F9F9; width: 90%; max-width: 500px; max-height: 90vh;
            border-radius: 1.25rem; box-shadow: 0 0.625rem 1.875rem rgba(0, 0, 0, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .settings-header {
            padding: 1rem; font-size: 1.125rem; font-weight: 600; text-align: center;
            border-bottom: 1px solid #EFEFEF; position: relative;
        }
        .settings-header .close-btn {
            position: absolute; top: 0.625rem; right: 0.625rem; background: #EAEAEA;
            border: none; border-radius: 50%; width: 1.875rem; height: 1.875rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .settings-header .close-btn svg { width: 0.875rem; height: 0.875rem; fill: #555; }
        .settings-body { padding: 1.25rem; overflow-y: auto; }
        .settings-group { margin-bottom: 1.5rem; }
        .settings-group h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: #333; }
        .settings-group label { font-size: 0.875rem; color: #555; }
        .settings-group input, .settings-group textarea, .settings-group select {
            width: 100%; padding: 0.625rem; border: 1px solid #DDD; border-radius: 0.5rem;
            font-size: 0.875rem; font-family: var(--font-family); background-color: #FFF; margin-top: 0.375rem;
        }
        .settings-group textarea { min-height: 5rem; resize: vertical; }
        .settings-group .slider-group { display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; }
        .settings-group .slider-group input[type="range"] { flex-grow: 1; margin: 0; }
        .settings-group .slider-group .slider-value { font-size: 0.875rem; min-width: 45px; text-align: right; }
        .settings-group .api-model-group { display: flex; gap: 0.625rem; }
        .settings-group .api-model-group button {
            padding: 0 0.9375rem; border-radius: 0.5rem; border: none; background-color: var(--button-bg-color);
            box-shadow: 0 1px 3px var(--shadow-color); cursor: pointer; transition: background-color 0.2s; margin-top: 0.375rem;
        }
        .settings-group .avatar-upload { display: flex; align-items: center; gap: 0.9375rem; margin-top: 0.375rem; }
        .settings-group .avatar-preview { width: 2.5rem; height: 2.5rem; border-radius: 50%; object-fit: cover; background-color: #EEE; }
        .settings-group .upload-btn {
            display: inline-block; padding: 0.5rem 0.75rem; background-color: var(--button-bg-color);
            border-radius: 0.5rem; box-shadow: 0 1px 3px var(--shadow-color); cursor: pointer; font-size: 0.875rem;
        }
        .settings-footer { padding: 1rem; border-top: 1px solid #EFEFEF; background-color: #F9F9F9; }
        #save-settings-btn {
            width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600; border: none;
            border-radius: 0.75rem; background-color: var(--button-bg-color); color: var(--text-color);
            cursor: pointer; box-shadow: 0 2px 4px var(--shadow-color); transition: background-color 0.2s, transform 0.1s;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div class="status-bar">
            <div class="status-bar-content default-bar">
                <div></div>
                <div class="char-info"><span class="char-name" id="display-char-name">角色</span></div>
                <button id="settings-btn" aria-label="设置"><svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.44,0.17-0.48,0.41L9.2,5.77C8.61,6.01,8.08,6.33,7.58,6.71L5.19,5.75C4.97,5.68,4.72,5.75,4.6,5.97L2.68,9.29 c-0.11,0.2-0.06,0.47,0.12,0.61l2.03,1.58C4.78,11.76,4.76,12.08,4.76,12.4c0,0.32,0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.04,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.48-0.41l0.36-2.54c0.59-0.24,1.12-0.56,1.62-0.94l2.39,0.96 c0.22,0.07,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"></path></svg></button>
            </div>
            <div class="status-bar-content edit-bar">
                <button id="cancel-delete-btn">取消</button>
                <button id="delete-btn" disabled>删除</button>
            </div>
        </div>
        <div class="chat-container" id="chat-container"></div>
        <div class="input-area">
            <button id="get-reply-btn" aria-label="获取回复"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></button>
            <input type="text" class="chat-input" id="chat-input" placeholder="输入消息..." autocomplete="off">
            <button id="send-btn" aria-label="发送"><svg viewBox="0 0 24 24"><path d="M2.01,21L23,12L2.01,3L2,10l15,2l-15,2L2.01,21z"></path></svg></button>
        </div>
    </div>
    <div class="settings-panel hidden" id="settings-panel">
        <div class="settings-content">
            <div class="settings-header">
                <span>聊天设置</span>
                <button class="close-btn" id="close-settings-btn" aria-label="关闭设置"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button>
            </div>
            <div class="settings-body">
                <div class="settings-group"><h3>显示设置</h3><label for="font-size-slider">字体大小</label><div class="slider-group"><input type="range" id="font-size-slider" min="12" max="20" step="1"><span id="font-size-value" class="slider-value">16px</span></div><br><label for="display-scale-slider">显示缩放</label><div class="slider-group"><input type="range" id="display-scale-slider" min="80" max="120" step="5"><span id="display-scale-value" class="slider-value">100%</span></div></div>
                <div class="settings-group"><h3>API 设置</h3><label for="api-url">API URL (自动补全 /v1)</label><input type="text" id="api-url" placeholder="例如: https://api.openai.com"><br><br><label for="api-key">API 密钥 (Key)</label><input type="password" id="api-key" placeholder="sk-..."><br><br><div class="api-model-group"><select id="api-model"></select><button id="fetch-models-btn">拉取模型</button></div></div>
                <div class="settings-group"><h3>人设信息</h3><label for="char-name-input">角色名字</label><input type="text" id="char-name-input" placeholder="角色会看到的名字"><br><br><label for="char-persona">角色人设</label><textarea id="char-persona" placeholder="角色的性格、背景、说话方式等。"></textarea><br><br><label for="user-persona">我的人设</label><textarea id="user-persona" placeholder="角色眼中的你是什么样的"></textarea></div>
                <div class="settings-group"><h3>附加提示词</h3><label for="system-prompt">附加的系统提示词</label><textarea id="system-prompt" placeholder="对角色行为的额外指令。"></textarea></div>
                <div class="settings-group"><h3>记忆深度</h3><label for="memory-depth">保留最近的消息条数 (0或留空为无限)</label><input type="number" id="memory-depth" placeholder="例如: 10"></div>
                <div class="settings-group"><h3>外观设置</h3><div class="avatar-upload"><img src="" id="char-avatar-preview" class="avatar-preview"><label for="char-avatar-upload" class="upload-btn">设置角色头像</label><input type="file" id="char-avatar-upload" accept="image/*" style="display: none;"></div><br><div class="avatar-upload"><img src="" id="user-avatar-preview" class="avatar-preview"><label for="user-avatar-upload" class="upload-btn">设置我的头像</label><input type="file" id="user-avatar-upload" accept="image/*" style="display: none;"></div><br><div><label for="bg-upload" class="upload-btn">设置聊天背景</label><input type="file" id="bg-upload" accept="image/*" style="display: none;"></div><br><label for="font-url" style="display:block; margin-top:0.625rem;">自定义字体 .ttf 链接 (可选)</label><input type="text" id="font-url" placeholder="https://.../font.ttf"></div>
            </div>
            <div class="settings-footer"><button id="save-settings-btn">保存所有设置</button></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const docElement = document.documentElement;
        const appContainer = document.getElementById('app-container');
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const getReplyBtn = document.getElementById('get-reply-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const displayCharName = document.getElementById('display-char-name');
        const deleteBtn = document.getElementById('delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        
        // Settings Inputs
        const fontSizeSlider = document.getElementById('font-size-slider');
        const fontSizeValue = document.getElementById('font-size-value');
        const displayScaleSlider = document.getElementById('display-scale-slider');
        const displayScaleValue = document.getElementById('display-scale-value');
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        const apiModelSelect = document.getElementById('api-model');
        const fetchModelsBtn = document.getElementById('fetch-models-btn');
        const charNameInput = document.getElementById('char-name-input');
        const charPersonaInput = document.getElementById('char-persona');
        const userPersonaInput = document.getElementById('user-persona');
        const systemPromptInput = document.getElementById('system-prompt');
        const memoryDepthInput = document.getElementById('memory-depth');
        const charAvatarUpload = document.getElementById('char-avatar-upload');
        const userAvatarUpload = document.getElementById('user-avatar-upload');
        const charAvatarPreview = document.getElementById('char-avatar-preview');
        const userAvatarPreview = document.getElementById('user-avatar-preview');
        const bgUpload = document.getElementById('bg-upload');
        const fontUrlInput = document.getElementById('font-url');

        let conversationHistory = [];
        let settings = {};
        let isWaitingForReply = false;
        let isEditMode = false;
        let selectedMessageIndices = new Set();
        let longPressTimer;
        
        const DEFAULT_AVATAR = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0RERCI+PHBhdGggZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgM2MxLjY2IDAgMyAxLjM0IDMgM3MtMS4zNCAzLTMgMy0zLTEuMzQtMy0zIDEuMzQtMyAzLTN6bTAgMTRjLTIuMzMgMC00LjM0LTEuMjEtNS41LTNjMS4yMy0xLjA3IDIuODUtMS43NSA0LjUtMS43NWgxYzEuNjUgMCAzLjI3LjY4IDQuNSAxLjc1LTEuMTYgMS43OS0zLjE3IDMtNS41IDN6Ii8+PC9wYXRoPjwvc3ZnPg==';

        function saveConversationHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
        }

        function saveSettings() {
            settings = {
                fontSize: fontSizeSlider.value, displayScale: displayScaleSlider.value,
                apiUrl: apiUrlInput.value.trim(), apiKey: apiKeyInput.value.trim(), apiModel: apiModelSelect.value,
                charName: charNameInput.value.trim(), charPersona: charPersonaInput.value, userPersona: userPersonaInput.value,
                systemPrompt: systemPromptInput.value, memoryDepth: memoryDepthInput.value, fontUrl: fontUrlInput.value.trim(),
                charAvatar: charAvatarPreview.src, userAvatar: userAvatarPreview.src, background: appContainer.style.backgroundImage,
                models: Array.from(apiModelSelect.options).map(opt => opt.value)
            };
            localStorage.setItem('chatAppSettings', JSON.stringify(settings));
            applySettings(true);
            alert('设置已保存！');
            settingsPanel.classList.add('hidden');
        }

        function loadAllData() {
            // Load Settings
            const savedSettings = localStorage.getItem('chatAppSettings');
            settings = savedSettings ? JSON.parse(savedSettings) : {};
            
            // Load Chat History
            const savedHistory = localStorage.getItem('chatHistory');
            conversationHistory = savedHistory ? JSON.parse(savedHistory) : [];

            // Populate Settings UI
            fontSizeSlider.value = settings.fontSize || 16;
            displayScaleSlider.value = settings.displayScale || 100;
            apiUrlInput.value = settings.apiUrl || ''; apiKeyInput.value = settings.apiKey || '';
            charNameInput.value = settings.charName || '角色'; charPersonaInput.value = settings.charPersona || '';
            userPersonaInput.value = settings.userPersona || ''; systemPromptInput.value = settings.systemPrompt || '';
            memoryDepthInput.value = settings.memoryDepth || ''; fontUrlInput.value = settings.fontUrl || '';
            charAvatarPreview.src = settings.charAvatar || DEFAULT_AVATAR; userAvatarPreview.src = settings.userAvatar || DEFAULT_AVATAR;
            apiModelSelect.innerHTML = '';
            if (settings.models && settings.models.length > 0) {
                settings.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model; option.textContent = model;
                    apiModelSelect.appendChild(option);
                });
                apiModelSelect.value = settings.apiModel;
            } else if(settings.apiModel) {
                const option = document.createElement('option');
                option.value = settings.apiModel; option.textContent = settings.apiModel;
                apiModelSelect.appendChild(option);
            }
            applySettings(true);
            renderFullChat();
        }

        function applySettings(updateAvatars = false) {
            const fontSize = fontSizeSlider.value;
            const displayScale = displayScaleSlider.value;
            docElement.style.setProperty('--font-size-chat', `${fontSize}px`);
            docElement.style.fontSize = `${displayScale}%`;
            fontSizeValue.textContent = `${fontSize}px`;
            displayScaleValue.textContent = `${displayScale}%`;
            const styleId = 'custom-font-style';
            let fontStyle = document.getElementById(styleId);
            if (fontUrlInput.value) {
                if (!fontStyle) { fontStyle = document.createElement('style'); fontStyle.id = styleId; document.head.appendChild(fontStyle); }
                fontStyle.innerHTML = `@font-face { font-family: 'CustomChatFont'; src: url('${fontUrlInput.value}'); } :root { --font-family: 'CustomChatFont', -apple-system, sans-serif; }`;
            } else { if(fontStyle) fontStyle.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }`; }
            if (settings.background) appContainer.style.backgroundImage = settings.background;
            else { appContainer.style.backgroundImage = 'none'; appContainer.style.backgroundColor = 'var(--background-color)'; }
            displayCharName.textContent = charNameInput.value || '角色';
            if (updateAvatars) updateExistingAvatars();
        }

        function updateExistingAvatars() {
            document.querySelectorAll('.message.user .avatar').forEach(img => img.src = userAvatarPreview.src);
            document.querySelectorAll('.message.character .avatar').forEach(img => img.src = charAvatarPreview.src);
        }

        function handleFileUpload(file, callback) {
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => callback(e.target.result);
                reader.readAsDataURL(file);
            }
        }

        function renderFullChat() {
            chatContainer.innerHTML = '';
            conversationHistory.forEach((msg, index) => {
                addMessageToUI(msg, index);
            });
             chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addMessageToUI(message, index) {
            const roleClass = message.role === 'assistant' ? 'character' : message.role;
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${roleClass}`;
            wrapper.dataset.index = index;

            wrapper.innerHTML = `
                <div class="message-selection-indicator">
                    <div class="selection-checkbox"></div>
                </div>
                <div class="message ${roleClass}">
                    <img src="${roleClass === 'user' ? userAvatarPreview.src : charAvatarPreview.src}" alt="${roleClass} avatar" class="avatar">
                    <div class="bubble-wrapper">
                        <div class="bubble">${message.content}</div>
                        <div class="read-status">已读</div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(wrapper);
            if (!isEditMode) {
                 chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function sendUserMessage() {
            const userInput = chatInput.value.trim();
            if (!userInput) return;
            const newMsg = { role: 'user', content: userInput };
            conversationHistory.push(newMsg);
            saveConversationHistory();
            addMessageToUI(newMsg, conversationHistory.length - 1);
            chatInput.value = '';
        }

        async function getAiReply() {
            if (isWaitingForReply || conversationHistory.length === 0 || conversationHistory[conversationHistory.length - 1].role !== 'user') return;
            if (!settings.apiUrl || !settings.apiKey) { alert('请先在设置中填写 API URL 和密钥！'); return; }
            
            isWaitingForReply = true;
            const originalCharName = displayCharName.textContent;
            displayCharName.textContent = "对方正在沉默地敲字呀…";

            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            let systemContent = `你正在进行一场微信聊天。你的核心能力是：通过【换行符】来一次性发送多条消息。这对于模仿真实对话的节奏至关重要。**你必须使用换行符（就像敲击回车键）来分隔独立的消息，而不是输出 '\\n' 这个字符串。**\n\n【正确示范】\n好的\n我明白了。\n\n【错误示范】\n好的\\n我明白了。\n\n当前真实时间是 ${timeString}。\n`;
            if (settings.charPersona) systemContent += `你的角色人设: ${settings.charPersona}\n`;
            if (settings.userPersona) systemContent += `与你对话的用户的人设: ${settings.userPersona}\n`;
            if (settings.systemPrompt) systemContent += `附加规则: ${settings.systemPrompt}`;

            let historyForApi = [...conversationHistory];
            const memoryDepth = parseInt(settings.memoryDepth, 10);
            if (!isNaN(memoryDepth) && memoryDepth > 0) historyForApi = historyForApi.slice(-memoryDepth);

            const messagesPayload = [{ role: 'system', content: systemContent }, ...historyForApi];
            
            try {
                const fullApiUrl = `${settings.apiUrl.replace(/\/$/, '')}/v1/chat/completions`;
                const response = await fetch(fullApiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.apiKey}` },
                    body: JSON.stringify({ model: settings.apiModel, messages: messagesPayload, stream: false })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const aiResponseText = data.choices[0].message.content;
                const aiResponses = aiResponseText.split(/(?:\r\n|\r|\n|\\n)+/);
                
                for (const res of aiResponses) {
                    const trimmedRes = res.trim();
                    if (trimmedRes) {
                        const newMsg = { role: 'assistant', content: trimmedRes };
                        conversationHistory.push(newMsg);
                        saveConversationHistory();
                        addMessageToUI(newMsg, conversationHistory.length - 1);
                        if (aiResponses.length > 1) await new Promise(resolve => setTimeout(resolve, 600));
                    }
                }
            } catch (error) {
                console.error('API Error:', error);
                const errorMsg = { role: 'assistant', content: `抱歉，出错了: ${error.message}` };
                conversationHistory.push(errorMsg);
                saveConversationHistory();
                addMessageToUI(errorMsg, conversationHistory.length - 1);
            } finally { 
                displayCharName.textContent = originalCharName;
                isWaitingForReply = false;
            }
        }
        
        // --- Edit Mode Logic ---
        function enterEditMode(initialIndex) {
            if (isEditMode || isWaitingForReply) return;
            isEditMode = true;
            appContainer.classList.add('edit-mode');
            toggleMessageSelection(initialIndex);
        }

        function exitEditMode() {
            isEditMode = false;
            appContainer.classList.remove('edit-mode');
            selectedMessageIndices.clear();
            document.querySelectorAll('.message-wrapper.selected').forEach(el => el.classList.remove('selected'));
            updateDeleteButton();
        }

        function toggleMessageSelection(index) {
            const wrapper = document.querySelector(`.message-wrapper[data-index="${index}"]`);
            if (!wrapper) return;

            if (selectedMessageIndices.has(index)) {
                selectedMessageIndices.delete(index);
                wrapper.classList.remove('selected');
            } else {
                selectedMessageIndices.add(index);
                wrapper.classList.add('selected');
            }
            updateDeleteButton();
        }

        function updateDeleteButton() {
            const count = selectedMessageIndices.size;
            deleteBtn.disabled = count === 0;
            deleteBtn.textContent = count > 0 ? `删除 (${count})` : '删除';
        }

        function deleteSelectedMessages() {
            if (selectedMessageIndices.size === 0) return;
            conversationHistory = conversationHistory.filter((_, index) => !selectedMessageIndices.has(index));
            saveConversationHistory();
            exitEditMode();
            renderFullChat();
        }

        // --- Event Listeners ---
        let pressTimer;
        let isDragging = false;
        
        function handlePressStart(e) {
            if (isEditMode) return;
            const wrapper = e.target.closest('.message-wrapper');
            if (!wrapper) return;
            isDragging = false;
            pressTimer = setTimeout(() => {
                if (!isDragging) {
                    enterEditMode(parseInt(wrapper.dataset.index, 10));
                }
            }, 500);
        }

        function handlePressMove() {
            isDragging = true;
            clearTimeout(pressTimer);
        }
        
        function handlePressEnd(e) {
            clearTimeout(pressTimer);
            if (isEditMode && !isDragging) {
                const wrapper = e.target.closest('.message-wrapper');
                if (wrapper) {
                    e.preventDefault();
                    toggleMessageSelection(parseInt(wrapper.dataset.index, 10));
                }
            }
        }
        
        chatContainer.addEventListener('mousedown', handlePressStart);
        chatContainer.addEventListener('mouseup', handlePressEnd);
        chatContainer.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        
        chatContainer.addEventListener('touchstart', handlePressStart, { passive: true });
        chatContainer.addEventListener('touchend', handlePressEnd);
        chatContainer.addEventListener('touchmove', handlePressMove, { passive: true });
        
        // Prevent default click behavior in edit mode to avoid conflicts
        chatContainer.addEventListener('click', (e) => {
            if (isEditMode) {
                 e.preventDefault();
            }
        });

        cancelDeleteBtn.addEventListener('click', exitEditMode);
        deleteBtn.addEventListener('click', deleteSelectedMessages);
        sendBtn.addEventListener('click', sendUserMessage);
        chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendUserMessage(); } });
        getReplyBtn.addEventListener('click', getAiReply);
        settingsBtn.addEventListener('click', () => settingsPanel.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsPanel.classList.add('hidden'));
        saveSettingsBtn.addEventListener('click', saveSettings);
        fontSizeSlider.addEventListener('input', () => applySettings());
        displayScaleSlider.addEventListener('input', () => applySettings());
        charAvatarUpload.addEventListener('change', (e) => handleFileUpload(e.target.files[0], (dataUrl) => charAvatarPreview.src = dataUrl));
        userAvatarUpload.addEventListener('change', (e) => handleFileUpload(e.target.files[0], (dataUrl) => userAvatarPreview.src = dataUrl));
        bgUpload.addEventListener('change', (e) => handleFileUpload(e.target.files[0], (dataUrl) => { settings.background = `url(${dataUrl})`; appContainer.style.backgroundImage = settings.background; }));
        
        async function fetchModels() {
            if (!apiUrlInput.value || !apiKeyInput.value) { alert('请先填写 API URL 和密钥！'); return; }
            const button = fetchModelsBtn; button.textContent = '拉取中...'; button.disabled = true;
            try {
                const fullModelUrl = `${apiUrlInput.value.trim().replace(/\/$/, '')}/v1/models`;
                const response = await fetch(fullModelUrl, { headers: { 'Authorization': `Bearer ${apiKeyInput.value.trim()}` } });
                if (!response.ok) throw new Error(`无法获取模型列表, HTTP 状态: ${response.status}`);
                const data = await response.json(); const models = data.data.map(model => model.id);
                apiModelSelect.innerHTML = '';
                models.forEach(modelId => { const option = document.createElement('option'); option.value = modelId; option.textContent = modelId; apiModelSelect.appendChild(option); });
                if (settings.apiModel && models.includes(settings.apiModel)) apiModelSelect.value = settings.apiModel;
                alert(`成功拉取 ${models.length} 个模型！`);
            } catch (error) { console.error('Fetch Models Error:', error); alert(`拉取模型失败: ${error.message}`);
            } finally { button.textContent = '拉取模型'; button.disabled = false; }
        }
        fetchModelsBtn.addEventListener('click', fetchModels);

        loadAllData();
    });
    </script>
</body>
</html>